/** * @license * Copyright Google LLC All Rights Reserved. * * Use of this source code is governed by an MIT-style license that can be * found in the LICENSE file at https://angular.io/license */import {PLATFORM_SERVER_ID} from '@angular/common/src/platform_id';import {Component, PLATFORM_ID, Provider, Type} from '@angular/core';import {ComponentFixture, TestBed} from '@angular/core/testing';import {DomSanitizer, SafeResourceUrl} from '@angular/platform-browser';import {expect} from '@angular/platform-browser/testing/src/matchers';import {withHead} from '@angular/private/testing';import {PRELOADED_IMAGES} from '../..//src/directives/ng_optimized_image/tokens';import {createImageLoader, IMAGE_LOADER, ImageLoader, ImageLoaderConfig} from '../../src/directives/ng_optimized_image/image_loaders/image_loader';import {ABSOLUTE_SRCSET_DENSITY_CAP, assertValidNg  describe('preload <link> element on a server', () => {    it('should create `<link>` element when the image priority attr is true', () => {// Only run this test in a browser since the Node-based DOM mocks don't// allow to override `HTMLImageElement.prototype.setAttribute` easily.  extraProviders: [{provide: PLATFORM_ID, useValue: PLATFORM_SERVER_ID}, { provide: IMAGE_LOADER, useValue: (config: ImageLoaderConfig) => config.width ? `https://angular.io/${config.src}?width=${config.width}` : `https://angular.io/${  ]`<img ngSrc="${src}" width="150" height="50" priority sizes="10vw" ngSrcset="100w">`;TestBed.overrideComponent(TestComponent, {set: {template: template}});const _document = TestBed.inject(DOCUMENT);const _window = _document.defaultView!;const setAttributeSpy =spyOn(_window.HTMLLinkElement.prototype, 'setAttribute').and.callThrough();const fixture = TestBed.createComponent(TestComponent);fixture.detectChanges();const head = _document.head;const rewrittenSrc = `https://angular.io/${src}`;const preloadLink = head.querySelector(`link[href="${rewrittenSrc}"]`);expect(preloadLink).toBeTruthy();const [name, value] = setAttributeSpy.calls.argsFor(0);expect(name).toEqual('as');expect(value).toEqual('image');expect(preloadLink!.getAttribute('rel')).toEqual('preload');expect(preloadLink!.getAttribute('as')).toEqual('image');expect(preloadLink!.getAttribute('imagesizes')).toEqual('10vw');exp    });    it('should not create a preload `<link>` element when src is already preloaded.', () => {// Only run this test in a browser since the Node-based DOM mocks don't// allow to override `HTMLImageElement.prototype.setAttribute` easily.  extraProviders: [{provide: PLATFORM_ID, useValue: PLATFORM_SERVER_ID}, { provide: IMAGE_LOADER, useValue: (config: ImageLoaderConfig) => `https://angular.io/${config.src}  ]});const template = `<imTestBed.overrideComponent(Te    });    it('should error when the number of pr// allow to override `HTMLImageElement.prototype.setAttribute` easily.  extraProviders: [ provide: IMAGE_LOADER,}  ] <img ngSrc="preloaderror2/img.png" width="150" height="50" priority> <img ngSrc="preloaderror3/img.png" width="150" height="50" priority> <img ngSrc="preloaderro4/img.png" width="150" height="50" priority> <img ngSrc="preloaderror5/img.png" width="150" height="50" priority> <img ngSrc="preloaderror6/img.png" width="150" height="50" priorit <img ngSrc="preloaderror8/img.png" width="150" height="50" priority> <img n `;expect(() => {  const fixture = createTestComponent(template);  fixture.detectChanges();})   'NG02961: The `NgOptimizedIm// Only run this test in a browser since the Nodeif (!isBrowser) return;setupTestingModule({  extraProviders: [{provide: IMAGE_LOADER,useValue: (config: ImageLoaderConfig) => `https://angular.io/${config.src}`  }]});const template = ` <img ngSrc="preloadbrowser1/img.png" width="150" height="50" priority> <i <img ngSrc="preloadbrowser4/img.png" width="150" height="50" priority> <img ngSrc="preloadbrowser5/img.png" width="150" height="50" priority> <img ngSrc="preloadbrowser6/img.png" width="150" height="50" priority <img ngSrc="preloadbrowser8/img.png" width `;TestBed.overrideComponent(TestComponent, {set: {template: template}});const _document = TestBed.inject(DOCUMENT);const fixture = TestBed.createComponent(TestComponent);fixture.detectChanges();    });    // Only run this test in a browser since the Node-b    if (!isBrowser) return;    setupTestingModule();     const _window = _document.defaultView!;  spyOn(_window.HTMLImageElement.protot    expect(img.getAttribute('loading')).toBe('eager');    let _imgInstance = null;    let    let _srcAttrId = -1;    const count = setAttributeSpy.calls.count();    for (let i = 0; i < count; i++) {if (!_imgInstance) {} else if (_imgInstance !== setAttributeSpy.calls.thisFor(i)) {  // Verify that the <img> instance is the same during the test.  fail('Unexpected instance of a second <img> instance present in a test.');}// Note: spy.calls.argsFor(i) returns args as an array: ['src', 'eager']const attrName = setAttributeSpy.calls.argsFor(i)[0];if (attrName == 'loading') _loadingAttrId = i;if (attrName == 'fetchpriority') _fetchpriorityAttrId = i;if     // Verify that both `loading` and `fetchpriority` are set *before* `src`:    expect(_loadingAttrId).toBeGreaterThan(-1); // was actually set    expect(_loadingAttrId).toBeLessThan(_srcAttrId);  // was set after `src`    expect(_fetchpriorityAttrId).toBeGreaterThan(-1); // was actually set    expect(_fetchpriorityAttrId).toBeLessThan(_srcAttrId);  // was set after `src`  });  it('should always reflect the width/height attributes if bound', () => {    setupTestingModule();    const template = '<img ngSrc="path/img.png" [width]="width" [height]="height">';    const fixture = createTestComponent(template);    fixture.detectChanges();    const nativeElement = fixture.nativeElement as HTMLElement;    const img = nativeElement.querySelector('img')!;    expect(img.getAttribute('width')).toBe('100');       it('should throw if both `src` and `ngSrc` are present', () => {setupTestingModule();const template = '<img ngSrc="path/img.png" src="path/img2.png" width="100" height="50">';expect(() => {  const fixture = createTestComponent(template);  fixture.detectChanges();}).toThro   'element with the `ngSrc="path/img.png"`) has detected that both ' +   '`src` and `ngSrc` have been set. Supplying both of these attributes ' +   'breaks lazy loading. The NgOptimizedImage directive sets `src` ' +   'itself based on the    });    it('should throw if both `ngSrcet` and `srcset` is present', () => {setupTestingModule();const template ='<img ngSrc="img-100.png" ngSrcset="100w, 200w" srcset="img-100.png 100w, img-200.png 200w" width="100" height="50">';expect(() => {  const fixture = createTestComponent(template);  f.toThrowError(   'NG02951: The NgOptimizedImage directive (activated on an <img> ' +   'element with the `ngSrc="img-100.png"`) has detected that both ' +   '`srcset` and `ngSrcset` have been set. Supplying both of these ' +   'attributes breaks lazy loading. ' +   'The NgOptimizedImage directive sets `srcset` itself based ' +   'on the value of `ngSrcset`. To fix this, please remove the `srcset` ' +   'attribute.');    });    it('should throw if `ngSrc` contains a Base64-encoded image (that starts with `data:`)', () => {setupTestingModule();expect(() => {  c  fixture.detectChanges();.toThrowError(   'is a Base64-encoded string (data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDov...). ' +   'NgOptimizedImage doe   'by removing `ngSrc` and // Domino does not support canvas elements properly,if (!isBrowser) {  return;}const canvas = document.createElement('canvas');canvas.toBlob(function(blob) {  con  const errorMessageRegExp = /NG02952: The NgOptimizedImage directive (.*?) has detected that `ngSrc` was set to a blob URL \(blob:/;  expect(() => {const template = '<img ngSrfixture.detectChanges();  done();});setupTestingModule();const template = '<img ngSrc="img.png">';expect(() => {  const fixture = createTestComponent(template);  fixture.detectChanges();.toThrowError(   'NG02954: The NgOptimized   'required attributes are missing: "width", "height". Includi   'To fix this, include "width" and "height" attributes on the image tag or turn on ' +   '"fill" mode with the `fill` attribute.');setupTestingModule();const template = '<img ngSrc="img.png" height="10">';expect(() => {  const fixture = createTestComponent(template);  fixture.detectChanges();}).toThrowError(   'NG02954: The NgOptimizedImage directive (activated on an <img> ' +   'element with the `ngSrc="img.png"`) has detected that these ' +   'required attributes are missing: "width". Including "width" and ' +   '"height" attributes will prevent image-related layout shifts. ' +   'To fix this, include "width" and "height" attributes on the image tag or turn on ' + setupTestingModule();const template = '<img ngSrc="img.png" width="0" height="10">';expect(() => {  const fixture = createTestComponent(template);  fixture.detectChanges();}).toThrowError(   'NG02952: The NgOptimizedImage directive (activated on an <img> ' +   'element with the `ngSrc="img.png"`) has detected that `width` ' +   'has an invalid value. To fix this, provide `width` as ' +    });    it('should throw if `width` has an invalid value', () => {setupTestingModule();const template = '<img ngSrc="img.png" width="10px" height="10">';expec  fixture.detectChanges();})   'NG02952: The NgOptimizedImage directive (activated on an <img> ' +   'element with the `ngSrc="img.png"`) has detected that `width` ' +   'has an invalid value. To    });    it('should throw if `height` is not set', () => {setupTestingModule();const template = '<img ngSrc="img.png" width="10">';expect(() => {  const fixture = createTestComponent(template);  fix.toThrowError(   'NG02954: The NgOptimizedImage directive (activated on an <img> ' +   'element with the    'attributes will prevent image-related layout shifts. ' +   'To fix this, include "width" and "height" attributes on the image tag or turn on ' +   '"fill" mode with the `fill` attribute.');    });    it('should throw if `height` is 0', () => {setupTestingModule();const template = '<img ngSrc="img.png" width="10" height="0">';expect(() => {  const fixture = createTestComponent(template);  fixture.detectChanges();}).toThrowError(   'NG02952: The NgOptimizedImage directive (activated on an <img> ' +   'element with the `ngSrc="img.png"`) has detected that `height` ' +   'has    });    it('should throw if `height` has an invalid value', () => {setupTestingModule();  const fixture = createTestComponent(template);  fixture.detectChanges();}).toThrowError(   'NG02952: The NgOptimizedImage directive (activated on an <img> element ' +   'with the `ngSrc="img.png"`) has detected that `height` has an invalid ' +   'value. To fix this, provide `height` as a number greater than 0.');    });    it('should throw if `ngSrc` value is not provided', () => {setupTestingModule();const template = '<img ngSrc>';expect(() => {  const fixture = createTestComponent(template);  fixture.detectChanges();}).toThrowError(   'NG0   'invalid value (``). ' +   'To fix this, chansetupTestingModule();const template = '<img ngSrc="  ">';expect(() => {  const fixture = createTestComponent(template);  fixture.detectChanges();}).toThrowError(   'NG02952: The NgOptimizedImage directive (activated on an <img> element ' +   'with the `ngSrc="  "`) has detected that `ngSrc` has an invalid value ' +   '(`  `). To fix this, change the value to a non-empty string.');    });    describe('invalid `ngSrcset` values', () => {const mockDirectiveInstance = {ngSrc: 'img.png'} as NgOptimizedImage;it('should throw for empty ngSrcSet', () => {  constreturn window.location.origin + `/path/${config.src}${width}.png`;  };  setupTestingModule({imageLoader});  const template = ` <img ngSrc="img" ngSrcset="" width="100" height="50">`;  expect(() => {c  }) .toThrowError( 'NG02952: The NgOptimizedImage directive (ac 'has an invalid value });it('should throw for invalid ngSrcSet', () => {  const imageLoader = (config: ImageLoaderConfig) => {const width = config.width ? `-${config.width}` : ``;return window.location.origin + `/path/${config.src}${width}.png`;  };  setupTestingModule({imageLoader});  const template = ` <img ngSrc="img" ngSrcset="100q, 200q" width="100" height="50">`;  expect(() => {const fixture = createTestComponent(template);fixture.detectChanges();  }) 'NG02952: The NgOptimizedImage directive (activated on an <img> element ' + 'with the `ngSrc="im 'of one or more width descriptors (e.g. "100w, 200w") or density descriptors ' + '(e.g. "1x, 2x").');});it('should throw if ngSrcset exceeds the density cap', () => {  const imageLoader = (config: ImageLoaderConfig) => {const width = config.width ? `-${config.width}` : ``;return window.location.origin + `/path/${config.src}${width}.png`;  };  setupTestingModule({imageLoader});  const template = ` <img ngSrc="img" ngSrcset="1x, 2x, 3x, 4x, 5x" width="100" height="50">`;  expect(() => {const fixture = createTestComponent(template);fixture .toThrowError( `NG0${INPUT}: The NgOptimizedImage directive (activated on an <img> element with the \`ngSrc="img"\`) ` + `has detected that the \`ngSrcset\` contains an unsupported image density:` + `\`1x, 2x, 3x, 4x, 5x\`. NgOptimizedImage generally recommends a max image density of ` + `${RECOMMENDED_SRCSET_DENSITY_CAP}x but supports image densities up to ` + `${ABSOLUTE_SRCSET_DENSITY_CAP}x. The human eye cannot distinguish between image densities ` + `greater than ${     RECOMMENDED_SRCSET_DENSITY_CAP}x - which makes them unnecessary for ` + `most use cases. Images that will be pinch-zoomed are typically the primary use case for ` + `${ABSOLUTE_SRCSET_DENSITY_CAP}x images. Please remove the high density descriptor and try again.`);});it('should throw if ngSrcset exceeds the density cap with multiple digits', () => {  const imageLoader = (config: ImageLoaderConfig) => {const w  };  setupTestingModule(`;  expect(() => {const fixture = createTestComponent(template);fixture.detectChanges();  }) .toThrowError( `NG0${     RuntimeErrorCodeINPUT}: The NgOptimizedImage directive (activated on an <img> element with the \`ngSrc="img"\`) ` + `has detected that the \`ngSrcset\` contains an unsupported image density:` + `\`1x, `${ABSOLUTE_SRCSET_DENSITY_CAP}x. The human eye cannot distinguish between image densities ` + `greater than ${ `most use cases. Images that will be pinch-zoomed are typically the primary use case for ` + `${ABSOLUTE_SRCSET_DENSITY_CAP}x images. Please remove the high density descriptor and try again.`);});it('should throw if width srcset is missing a comma', () => {  expect(() => {assertValidNgSrcset(mockDirectiveInstance, '100w 200w');  }).toThrowError();});it('should throw if density srcset is missing a comma', () => {  expect(() => {assertValidNgSrcset(mockDirectiveInstance, '1x 2x');  }).toThrowError();});it('assertValidNgSrcset(mockDirectiveInstance, '100x, 2x');  }).toThrowError();  expect(() => {assertValidNgSrcset(mockDirectiveInstance, 'a.png 100w, b.png 200w');  }).toThrowError();});it('should throw if density srcset includes a file name', () => {  expect(() => {assertValidNgSrcset(mockDirectiveInstance, 'a.png 1x, b.png 2x');  }).toThrowError();});it('should throw if srcset starts with a letter', () => {  expect(() => {assertValidNgSrcset(mockDirectiveInstance, 'a100w, 200w');  }).toThrowError();});it('should throw if srcset starts with another non-digit', () => {  expec  }).toThrowError();});it('should throw iassertValidNgSrcset(mockDirectiveInstance, 'foo, 1x');  }).toThrowError();});it('should throw if later descriptors in srcset are junk', () => {  expect(() => {assertValidNgSrcset(mockDirectiveInstance, '100w, foo');  }).toThrowError();});it('should throw if srcset has a density descriptor after a width descriptor', () => {  expect(() => {assertValidNgSrcset(mockDirectiveInstance, '100w, 1x');  }).toThrowError();});it('assertValidNgSrcset(mockDirectiveInstance, '1x, 200w');  }).toThrowError();    });    const inputs = [['width', 10], ['height', 20], ['priority', true], ['fill', true], ['loading', true],['sizes', '90vw'], ['disableOptimizedSrcset', true], ['loaderParams', '{foo: "test1"}']    ];    inputs.forEach(([inputName, value]) => {it(`should throw if the \`${inputName}\` input changed after directive initialized the input`,@Component({  selector: 'test-cmp',  template: `<img   [ngSrc]="ngSrc"   [wid   [priority]="priority"   [fill]="fill"   [sizes]="sizes"   [disableOptimizedSrcset]="disableOptimizedSrcset"   [loaderParams]="loaderParams" >`})class TestComponent {  width = 100;  height = 50;  ngSrc = 'img.png';  priority = false;  fill   sizes = '100vw';  disableOptimizedSrc}setupTestingModule({component: TestComponent});// Initial renderconst fixture = TestBed.createComponent(TestComponent);fixture.detectChanges();const expectedErrorMessage =  //`NG02953: The NgOptimizedImage directive (.*)? ` +`has detected that \`${inputName}\` was updated after initialization`;expect(() => {  // Update input (expect to throw)  (fixture.componentInstance as unknown as   {[key: string]: unknown})[inputName as string] = value;  fixtu    it(`should not throw if ngSrc changed after directive is initialized`, () => {@Component({  template: `<img   [ngSrc]="ngSrc"   [width]="width"   [height]="height"   [loading]="loading"   [sizes]="sizes"})class TestComponent {  width = 100;  height = 50;  ngSrc = 'img.png';  loading = false;  sizes = '100vw';}setupTestingModule({component: TestComponent});// Initial renderconst fixture = TestBed.createComponent(TestComponent);fixture.detectChanges();expect(() => {  fixture.componentInstance.ngSrc = 'newImg.png';  f    });    it('should accept a safeUrl ngSrc value', () => {@Component({  selector: 'test-cmp',  template: `<img   [ngSrc]="bypassImage"   height="600" >`})class TestComponent {  rawImage = `javascript:alert("Hi there")`;  bypassImage: SafeResourceUrl;  constructor(private sanitizer: DomSanitizer) {this.bypassImage = sanitizer.bypassSecurityTrustResourceUrl(this.rawImage);  }}setupTestingModule({component: TestComponent});const fixture = TestBed.createComponent(TestComponent);fixture.detectChanges();let nativeElement = fixture.nativeElement as HTMLElement;let    });  });  describe('lazy loading', () => {    it('should eagerly load priority images', () => {setupTestingModule();const template = '<img ngSrc="path/img.png" width="150" height="50" priority>';const fixture = createTestComponent(template);fixture.detectChanges();const nativeexpect(img.getAttribute('loading')).toBe('eager');    });    it('should lazily load non-priority images', () => {setupTestingModule();const template = '<img ngSrc="path/img.png" width="150" height="50">';const fixture = createTestComponent(template);fixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const img = nativeElement.querySelector('img')!;expect(img.getAttribute('loading')).toBe('lazy');    });  });  describe('loading attribute', () => {    it('should override the default loading behavior for non-priority images', () => {setupTestingModule();const template = '<img ngSrc="path/img.png" width="150" height="50" loading="eager">';const fixture = createTestComponent(template);fixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const img = nativeElement.querySelector('img')!;expect(img.getAttribute('loading')).toBe('eager');    });    it('should throw if used with priority images', () => {setupTestingModule();const template ='<img ngSrc="path/img.png" width="150" height="50" loading="eager" priority>';expect(() => {  c}).toThrowError(   'NG02952: The NgOptimizedImage directive (activated on an <img> element ' +   'with the `ngSrc="path/img.png"`) has detected that the `loading` attribute ' +   'was used on an image that was marked "priority". Setting `loading` on priority ' +   'images is not allowed because these images will always be eagerly loaded. ' +   'To fix this, remove the â€œloadingsetupTestingModule();const template = '<img ngSrc="path/img.png" width="150" height="50" loading="auto">';const fixture = createTestComponent(template);fixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const img = nativeElement.querySelector('img')!;expect(img.getAttribute('loading')).toBe('auto');    });    it('should throw for invalid loading inputs', () => {setupTestingModule();const template = '<img ngSrc="path/img.png" width="150" height="150" loading="fast">';expect(() => {  const fixture = createTestComponent(template);  fixture.detectChanges();}).toThrowError(   'NG02952: The NgOptimizedImage directive (activated on an <img> element ' +   'with the `ngSrc="path/img.png"`) has detected that the `loading` attribute ' +   'has an invalid value (`fast`). To fix this, provide a valid value ("lazy", ' +   '"eager", or "auto").');    });  });  describe('fetch priority', () => {    it('should be "high" for priority images', () => {setfixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const img = nativeElement.querySelector('img')!;expect(img.getAttribute('fetchpriority')).toBe('high');    });    it('should be "auto" for non-priority images', () => {setfixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const img = nativeElement.querySelector('img')!;expect(img.getAttribute('fetchpriority')).toBe('auto');    });  }setupTestingModule();const template = '<img ngSrc="a.png" width="100" height="50">';const fixture = createTestComponent(template);fixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;con    });    it('should add a data attribute to the element for identification, when ngSrc bound', () => {setupTestingModule();const template = `<img [ngSrc]="'a.png'" width="100" height="50">`;const fixture = createTestComponent(template);fixconst img = nativeElement.querySelector('img')!;expect(img.getAttribute('ng-img')).not.toBeNull();    });  });  describe('fill mode', () => {   expect(() => {  const fixture = createTestComponent(template);  fixture.detectChanges();}).not.toThrow();   setupTestingModule();const template = '<img ngSrc="path/img.png" width="500" fill>';expect(() => {  const fixture = createTestComponent(template);  fixture.detectChanges();})   'NG02952: The NgOptimizedImage directive (activated on an <img> element with the ' +   '`ngSrc="path/img.png"`) has detected that the attributes `height` and/or `width` ' +   'are present along with the `fill` attribute. Because `fill` mode causes an image ' +   'to fill its containing element, the size attributes have no effect and should be removed.');   setupTestingModule();const template = '<img ngSrc="path/img.png" height="500" fill>';expect(() => {  const fixture = createTestComponent(template);  fixture.detectChanges();})   'NG02952: The NgOptimizedImage directive (activated on an <img> element with the ' +   '`ngSrc="path/img.png"`) has detected that the attributes `height` and/or `width` ' +   'are present along with the `fill` attribute. Because `fill` mode causes an image ' +   'to fill its containing element, the size attributes have no effect and should be removed.');   setupTestingModule();const template = '<img ngSrc="path/img.png" fill>';const fixture = createTestComponent(template);fixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const img = nativeElement.querySelector('img')!;expect(img.getAttribute('style')?.replace(/\s/g, '')).toBe('    it('should augment existing styles in fill mode', () => {setupTestingModule();const template = '<img ngSrc="path/img.png" style="border-radius: 5px; padding: 10px" fill>';const fixture = createTestComponent(template);fixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const img = nativeElement.querySelector('img')!;expect(img.getAttribute('style')?.replace(/\s/g, ''))   'border-radius:5px;padding:10px;position:absolute;width:100%;height:100%;inset:0px;');    });    it('should not add fill styles if not in fill mode', () => {setupTestingModule();const template ='<img ngSrc="path/img.png" width="400" height="300" style="position: relative; border-radius: 5px">';const fixture = createTestComponent(template);fixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const img = nativeElement.querySelector('img')!;expect(img.getAttribute('style')?.replace(/\s/g, '')).toBe('position:relative;border-radius:5px;');    });    it('should add default sizes value in fill mode', () => {setupTestingModule();const template = '<img ngSrc="path/img.png" fill>';const fixture = createTestComponent(template);fixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const img = nativeElement.querySelector('img')!;expect(img.getAttribute('sizes')).toBe('100vw');    });    it('should not overwrite sizes value in fill mode', () => {setupTestingModule();const template = '<img ngSrc="path/img.png" sizes="50vw" fill>';const fixture = createTestComponent(template);fixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const img = nativeElement.querySelector('img')!;expect(img.getAttribute('sizes')).toBe('50vw'); setupTestingModule();const template = '<img ngSconst nativeElement = fixture.nativeElement as HTMLElement;const img = nativeElement.querySelector('img')!;expect(img.getAttribute(   `${IMG_BASE_URL}/path/img.png 640w, ${IMG_BASE_URL}/path/img.png 750w, ${   IMG_BASE_URL}/path/img.png 828w, ` +   `${IMG_BASE_URL}/path/img.png 1080w, ${IMG_BASE_URL}/path/img.png 1200w, ${   IMG_BASE_URL}/path/img.png 1920w, ` +   `${IMG_BASE_URL}/path/img.png 2048w, ${IMG_BASE_URL}/path/img.png 3840w`);    });  });  describe('preconnect detector', () => {    const imageLoader = () => {// We need something different from the `localhostreturn 'https://angular.io/assets/images/logos/angular/angular.svg';    };    it('should log a warning if there is no preconnect link for a priority image', withHead('', () => {ingModule({imageLoader});soleWarnSpy = spyOn(console, 'warn');plate = '<img ngSrc="a.png" width="100" height="50" priority>';ture = createTestComponent(template);etectChanges();nsoleWarnSpy.calls.count()).toBe(1);nsoleWarnSpy.calls.argsFor(0)[0])  .toBe(  'NG02956: The NgOptimizedImage directive (activated on an <img> element ' +  'with the `ngSrc="a.png"`) has detected that there is no preconnect tag ' +  'present for this image. Preconnecting to the origin(s) that serve ' +  'priority images ensures that these images are delivered as soon as ' +  'possible. To fix this, please add the following element into the <head> ' +  'of the document:' +  '\n  <link rel="preconnect" href="https://angular.io">'); }));    it('should not log a warning if there is no preconnect link, but the image is not set as a priority', withHead('', () => {iture = createTestComponent(template);nsoleWarnSpy.calls.count()).toBe(0); }));    it('should log a warning if there is a preconnect, but it doesn\'t match the priority image', withHead('<link rel="preconnect" href="http://angular.io">', () => {ingModule({imageLoader});soleWarnSpy = spyOn(console, 'warn');plate = '<img ngSrc="a.png" width="100" height="50" priority>';ture = createTestComponent(template);etectChanges();nsoleWarnSpy.calls.count()).toBe(1);nsoleWarnSpy.calls.argsFor(0)[0])  .toBe(  'NG02956: The NgOptimizedImage directive (activated on an <img> element ' +  'with the `ngSrc="a.png"`) has detected that there is no preconnect tag ' +  'present for this image. Preconnecting to the origin(s) that serve priority ' +  'images ensures that these images are delivered as soon as possible. ' +  'To fix this, please add the following element into the <head> of the document:' +  '\n  <link rel="preconnect" href="https://angular.io">'); }));    it('should log a warning if there is no matching preconnect link for a priority image, but there is a preload tag', withHead('<link rel="preload" href="https://angular.io/assets/images/logos/angular/angular.svg" as="image">',() => {  setupTestingModule({imageLoader});  const consoleWarnSpy = spyOn(console, 'warn');  const template = '<img ngSrc="a.png" width="100" height="50" priority>';  const fixture = createTestComponent(template);  fixture.detectChanges();  expect(consoleWarnSpy.calls.count()).toBe(1);  expect(consoleWarnSpy.calls.argsFor(0)[0])  .toBe('NG02956: The NgOptimizedImage directive (activated on an <img> element ' +'with the `ngSrc="a.png"'images ensures that these images are delivered as soon as possible. ' +'To fix this, please add the following element into the <head> of the document:' +'\n  <link rel="preconnect" href="https://angular.io">');}));    it('should not log a warning if there is a matching preconnect link for a priority image (with an extra `/` at the end)', withplate = '<img ngSrc="a.png" width="100" height="50" priority>';ture = createTestComponent(template);etectChanges(); no wa }));    ['localhost', '127.0.0.1', '0.0.0.0'].forEach(blocklistedHostname => {it(`should not log a warning if an origin domain is blocklisted ` +  `(checking ${blocklistconst imageLoader = () => {  return `http://${blocklistedHostname}/a.png`;};setupTeconst fixture = createTestComponent(template);fixture.detectChangesit(`should allow passing host names`, withHead('', () => {const providers = [{provide: PRECONNECT_CHECK_BLOCKLIST, useValue: 'angular.io'}];setupTestingModule({imagconst fixture = createTestComponent(template);fixture.detectChanges();// Expect no warnings in the console.expect(consoleWarnSpy.calls.count()).toBe(0);it(`should allow passing origins`, withHead('', () => {constsetupTestingModule({imageLoader, extraProviders: providers});const consoleWarnSpy = spyOn(console, 'warn');const template = '<img ngSrc="a.png" width="100" height="50" priority>';const fixture = createxpect(consoleWarnSpy.calls.count()).toBe(0);it(`should allow passing arrays of host names`, withHead('', () => {const providers =setupTestingModule({imageLoader, extraProviders: providers});const consoleWarnSpy = spyOn(console, 'warn');const template = '<img ngSrc="a.png" width="100" height="50" priority>';const fixture = createTestComponent(template);fixtureit(`should allow passing nested arrays of host names`, withHead('', () => {const providers =setupTestingModule({imageLoader, extraProviders: providers});const consoleWarnSpy = spyOn(console, 'warn');const template = '<img ngSrc="a.png" width="100" height="50" priority>';const fixture = createTestComponent(template);fixture.detectChanges();// Expect no warnings in the console.expect(consoleWarnSpy.calls.count()).toBe(0);    });  });  describe('loaders', () => {    const imageLoaderWithData = (config: ImageLoaderConfig) => {let paramsString = '';if (config.loaderParams) {  paramsString = Object.entries(config.loaderParams).map(entry => `${entry[0]}=${entry[1]}`).join('&');}let que    };    // Test complex loaderParams schema with nesting:    // loaderParams =    //   transforms2: {example2: "bar"}    // }    const nestedImageLoaconfig.loaderParams?.['transforms2'].example2}`;    };    it('should set `src` to match `ngSrc` if image loader is not provided', () => {setupTestingModule();const template = `<img ngSrc="${IMG_BASE_URL}/img.png" width="100" height="50">`;const fconst img = nativeElement.querySelector('img')!;expect(img.src).toBe(setUpModuleNoLoader();const template = `<img ngSrc="https://some.imgix.net/img.png" width="100" height="50">`;const fixture = createTestComponent(template);const consoleWarnSpy = spyOn(console, 'warn');fixture.detectChanges();expect(consoleWarnSpy.calls.count()).toBe(1);expect(consoleWarnSpy.calls.argsFor(0)[0]).toMatch(/your images may be hosted on the Imgix CDN/);    });    it('should warn if there is no image loader but using ImageKit URL', () => {setUpModuleNoLoader();const template = `<img ngSrc="https://some.imagekit.io/img.png" width="100" height="50">`;const fixture = createTestComponent(template);const consoleWarnSpy = spyOn(console, 'warn');fixture.detectChanges();expect(consoleWarnSpy.calls.count()).toBe(1);expec    });    it('should warn if there is no image loader but using Cloudinary URL', () => {setUpModuleNoLoader();const template = `<img ngSrc="https://some.cloudinary.com/img.png" width="100" height="50">`;const fixture = creatfixture.detectChanges();expect(consoleWarnSpy.calls.count()).toBe(1);expect(consoleWarnSpy.calls.argsFor(0)[0]).toMatch(/your images masetupTestingModule();const template = `<img ngSrc="https://some.cloudinary.com/img.png" width="100" height="50">`;const fixture = createTestComponent(template);const consoleWarnSpy = spyOn(console, 'warn');fixturesetUpModuleNoLoader();const template = `<img ngSrc="img.png" ngSrcset="100w, 200w" width="150" height="50">`;const fixture = creatfixture.detectChanges();expect(consoleWarnSpy.calls.count()).toBe(1);expect(consoleWarnSpy.calls.argsFor(0)[0]).toBe(   RuntimeErrorCode .MISSING_NECESSARY_LOADER}: The NgOptimizedImage directive (activated on an <img> element ` +   'with the `ngSrc="img.png"`) has detected that the `ngSrcset` attribute is ' +   'present but no image loader is configured (i.e. the default one is being used), ' +   `w    });    it('should warn if there is no image loader but `loaderParams` is present', () => {setUpModuleNoLoader();const template =`<img ngSrc="img.png" width="150" height="50" [loaderParams]="{foo: 'test'}">`;const fixture = createTestComponent(template);fixture.detectChanges();expect(consoleWarnSpy.calls.count()).toBe(1);expect(consoleWarnSpy.calls.argsFor(0)[0]).toBe(   `NG0${   RuntimeErrorCode .MISSING_NECESSARY_LOADER}: The NgOptimizedImage directive (activated on an <img> element ` +   'with the `ngSrc="img.png"`) has detected that the `loaderParams` attribute is ' +   'present but no image loader is configured (i.e. the default one is being used), ' +   `which means that the loaderParams data will not be consumed and    });    it('should set `src` using the image loader provided via the `IMAGE_LOADER` token to compose src URL', () => {geLoader = (config: ImageLoaderConfig) => `${IMG_BASE_URL}/${config.src}`;ingModule({imageLoader});plate = `c="img.png" width="150" height="50">c="img-2.png" width="150" height="50"> `;etectChanges();iveElement = fixture.nativeElement as HTMLElement;s = nativeElement.querySelectorAll('img')!;gs[0].src.trim()).toB });    it('should use the image loader to update `src` if `ngSrc` updated', () => {@Component({  selector: 'test-cmp',  template: `<img[ngSrc]="ngSrc"width="300"height="300"})class TestComponent {}const imageLoader = (config: ImageLoaderConfig) => `${IMG_BASE_URL}/${config.src}`;setupTestingModule({imageLoader, component: TestComponent});const fixture = TestBed.createComponent(TestComponent);fixture.detectChanges();let nativeElement = fixture.nativeElement as HTMLElement;let imgs = nativeElement.querySelectorAll('img')!;expect(imgs[0].src).toBe(`${IMG_BASE_URL}/img.png`);fixture.componentInstance.ngSrc = 'updatedImg.png';fixture.detectChanges();expect(imgs[0].src).toBe(`${IMG_BASE_URL}/updatedImg.png`);    });    it('should use the image loader to update `srcset` if `ngSrc` updated', () => {@Component({  selector: 'test-cmp',  template: `<imgwidth="300"height="300"sizes="100vw"})class TestComponent {  ngSrc = `img.png`;}const imageLoader = (config: ImageLoaderConfig) => {  const width = config.width ? `?w=${config.width}` : ``;  return `${IMG_BASE_URL}/${config.src}${width}`;};setupTestingModule({imageLoader, component: TestComponent});const fixture = TestBed.createComponent(TestComponent);fixture.detectChangesexpect(imgs[0].getAttribute('srcset'))   IMG_BASE_URL}/img.png?w=828 828w, ${IMG_BASE_URL}/img.png?w=1080 1080w, ${   IMG_BASE_URL}/img.png?w=1200 1200w, ${IMG_BASE_URL}/img.png?w=1920 1920w, ${   IMG_BASE_URL}/img.png?w=2048 2048w, ${IMG_BASE_URL}/img.png?w=3840 3840w`);fixture.componentInstance.ngSrc = 'updatedImg.png';nativeElement = fixture.nativeElement as HTMLElement;imgs = nativeElement.querySelectorAll('img')!;fixture.detectChanges();expect(imgs[0].getAttribute('srcset')).toBe(`${IMG_BASE_URL}/updatedImg.png?w=640 640w, ${   IMG_BASE_URL}/upda   IMG_BASE_URL}/updatedImg.png?w=1200 1200w, ${   IMG_BASE_URL}/updatedImg.png?w=2048 2048w, ${   IMG_BASE_URL}/updatedImg.png?w=3840 3840w`);    });    it('should pass absolute URLs defined in the `ngSrc` to custom image loaders provided via the `IMAGE_LOADER` token', () => {geLoader = (config: ImageLoaderConfig) => `${config.src}?rewritten=true`;ingModule({imageLoader});plate = ` <img ngSrc="${IMG_BASE_URL}/img.png" width="150" height="50">`;ture = createTestComponent(template);etectChanges();iveElegs[0].src.trim()).toBe(`${IMG_BASE_URL}/img.png?rewritten=true`); });    it('should pass data payload from loaderParams to custom image loaders', () => {const template = `  <img ngSrc="${IMG_BASE_URL}/img.png" width="150" height="50"[loaderParams]="{testProp1: 'testValue1', testProp2: 'testValue2'}" />`;const fixture = createTestComponent(template);fixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const imgs = nativeElement.querySelectorAll('img')!;expect(imgs[0].src).t@Component({  template: `<imgngSrc"width""height"rams]="params" >`})class TestComponent {  width = 300;  params = {transforms1: {example1: 'foo'}, transforms2: {example2: 'bar'}};}setupTestingModule({imageLoader: nestedImageLoader, component: TestComponent});const fixture = TestBed.createComponent(TestComponent);fixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const imgs = nativeElement.querySelectorAll('img')!;expect(imgs[0].src).tsetupTestingModule({imageLoader: imageLoaderWithDat  <img ngSrc="${IMG_BASE_URL}/img.png" width="150" height="50"[loaderParams]="{testProp1: 'testValue1', testProp2: 'testValue2'}" />`;const fixture = createTestComponent(template);fixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const imgs = nativeElement.querySelectorAll('img')!;expect(imgs[0].srcset).toBe(`${IMG_BASE_URL}/img.png?w=150&testProp1=testValue1&testProp2=testValue2 1x, ${   IMG_BASE_URL}/img.png?w=300&testProp1=testValue1&testProp2=testValue2 2x`);    });    it('should pass data payload from loaderParams to loader when generating responsive srcsets', () => {ingMo  <img ngSrc="${IMG_BASE_URL}/img.png" width="150" height="50" sizes="100vw"[loaderParams]="{testProp1: 'testValue1', testProp2: 'testValue2'}" />`;ture = createTestComponent(template);etectChanges();iveElegs[0].srcset)  .toBe(`${IMG_BASE_URL}/img.png?w=640&testProp1=testValue1&testProp2=testValue2 640w, ${  IMG_BASE_URL}/img.png?w  IMG_BASE_URL}/img.png?w=1080&testProp1=testValue1&testProp2=testValue2 1080w, ${  IMG_BASE_URL}/img.png?w=1200&testProp1=testValue1&testProp2=testValue2 1200w, ${  IMG_BASE_URL}/img.png?w=1920&testProp1=testValue1&testProp2=testValue2 1920w, ${  IMG_BASE_URL} });    it('should set `src` to an image URL that does not include a default width parameter', () => {const imageLoader = (config: ImageLoaderConfig) => {  const widthStr = config.width ? `?w=${config.width}` : ``;  return `${IMG_BASE_URL}/${config.src}${widthStr}`;};setupTestingModule({imageLoader});const template = '<img ngSrc="img.png" width="150" height="50">';const fixture = createTestComponent(template);fixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const img = nativeElement.querySelector('img')!;expect(img.src).toBe(`${IMG_BASE_URL}/img.png`);    }derWithPath = createImageLoader(createImgUrl);t({selector: 'test-cmp',template: '<img ngSrc="a.ingModule(  {component: TestComponent, extraProviders: [loaderWithPath('https://default.io')]});ture = TestBed.createComponent(TestComponent);etectChanges();aultLoader = TestBed.inject(IMAGE_LOADER);iveElement = fig.src).toBe('https://component.io/a.png'); }));    describe('`ngSrcset` values', () => {let iconst width = config.width ? `?w=${config.width}` : ``;return `${IMG_BASE_URL}/${config.src}${width}`;  };  setupTestingModule({imageLoader});  const template = `<img ngSrc="img.png" ngSrcset="100w, 200w" width="100" height="50">  const fixture = createTestComponent(template);  fixture.detectChanges();  const nativeElement = fixture.nativeElement as HTMLElement;  const img = n  expect(img.srcset) .toBe(`${IMG_BASE_URL}/img.png?w=100 100w, ${IMG_BASE_URL}/img.png?w=200 200w`);});it('should set the `srcset` using the `ngSrcset` value with density descriptors', () => {  setupTestingModule({imageLoader});  const template = `<img ngSrc="img.png" ngSrcset="1x, 2x" width="100" height="50">  const fixture = createTestComponent(template);  fixture.detectChanges();  const nativeElement = fixture.nativeElement as HTMLElement;  const img = nativeElement.querySelector('img')!;  expect(img.src).toBe(`${IMG_BASE_URL}/img.png`);  expect(img.srcset) .toB  setupTestingModule({imageLoader});  const template = `<img ngSrc="img.png" ngSrcset="100w" width="100" height="50">  const fixture = createTestComponent(template);  fixture.detectChanges();  const nativeElement = fixture.nativeElement as HTMLElement;  const img = nativeElement.querySelector('img')!;  expect(img.src.trim()).toBe(`${IMG});it('should set the `srcset` if `ngSrcSet` has extra spaces', () => {  setupTestingModule({imageLoader});  const template = `<img ngSrc="img.png" ngSrcset="  100w,  200w   " width="100" height="50">  const fixture = createTestComponent(template);  fixture.detectChanges();  expect(img.src).toBe(`${IMG_BASE_URL}/img.png`);  expect(img.srcset) .toBe(`${IMG_BASE_URL}/img.png?w=100 100w, ${IMG_BASE_URL}/img.png?w=200 200w`);});it('should set the `srcset` if `ngSrcSet` has a trailing comma', () => {  setupTestingModule({imageLoader});  const template = `<img ngSrc="img.png" ngSrcset="1x, 2x," width="100" height="50">  const fixture = createTestComponent(template);  fixture.detectChanges();  const nativeElement = fixture.nativeElement as HTMLElement;  const img = nativeElement.querySelector('img')!;  expect(img.src).toBe(`${IMG_BASE_URL}/img.png`);  ex});it('should set the `srcset` if `ngSrcSet` has 3+ srcs', () => {  setupTestingModule({imageLoader});  const template = `<img ngSrc="img.png" ngSr  const img = nativeElement.querySelector('img')!;  expect(img.src).toBe(`${IMG_BASE_URL}/img.png`);  expect(img.srcset) .toBe( `${IMG_BASE_URL}/img.png?w=200 200w, ` + `${IMG_BASE_URL}/img.png?w=300 300w`);});it<img ngSrc="img.png" ngSrcset="1.75x, 2.5x, 3x" width="100" height="50">  const fixture = createTestComponent(template);  fixture.detectChanges();  const nativeElement = fixture.nativeElement as HTMLElement;  const img = nativeElement.querySelector('img')!;  expect(img.src).toBe(`${IMG_BASE_URL}/img.png`);  expect(img.srcset) .toBe( `${IMG_BASE_URL}/img.png?w=175 1.75x, ` + `${IMG_BASE_URL}/img.png?w=250 2.});    });    describe('sizes attribute', () => {it('should pass through the sizes attribute', () => {  setupTestingModule();   const fixture = createTestComponent(template);  fixture.detectChanges();  const nativeEleme .toBe(  setupTestingModule();  const template = '<img ngSrc="path/img.png" width="100" height="50" sizes="(min-width: 768px) 500px, 100vw">';  expect(() => {const fixture = createTestComponent(template);  }) .toThrowError( 'NG02952: The NgOptimizedImage directive has detected that `sizes` was set to a string including pixel values. ' + 'For automatic `srcset`});it('should throw if a complex `sizes` is used '<img ngSrc="path/img.png" width="100" height="50" sizes="(min-width: 768px) 500px, 100vw" srcset="www.example.com/img.png?w=500 768w, www.example.com/img.png?w=2000" >';  expect(() => {const fixture = createTestComponent(template);fixture.detectChanges();  }) 'NG02952: The NgOptimizedImage directive has detected that `sizes` was set to a string including pixel values. ' + 'For automatic `srcset` generation, `sizes` must only include responsive values, such as `sizes="50vw"` or ' + '`sizes="(min-width: 768px) 50vw, 100vw"`. To fix this, modify the `sizes` attribute, or provide your own \`ngSrcset\` value directly.');});  setupTestingModule();  const template = '<img ngSrc="path/img.png" width="100" heighconst fixture = createTestComponent(template);fixture.detectChanges();  }).not.toThrow();});    });    describe('automatic srcset generation', () => {  const width = config.width ? `?w=${config.width}` : ``;  return `${IMG_BASE_URL}/${config.src}${width}`;};it('should not generate a srcset if the default noop loader is used', () => {  setupTestingModule({no  `;  const fixture = createTestComponent(templat  const img = nativeElement.querySelector('img')!;  expect(img.getAttribute('srcset')).toBeNull();});it('should add a responsive srcset to the img element if sizes attribute exists', () => {  setupTestingModule({imageLoader});  const template = `<img ngSrc="img" width="100" height="50" sizes="100vw">  const fixture = createTestComponent(template);  fixture.detectChanges();  const nativeElement = fixture.nativeElement as HTMLElement;  const img = nativeElement.querySelector('img')!;  expect(img.getAttribut IMG_BASE_URL}/img?w=828 828w, ${IMG_BASE_URL}/img?w=1080 1080w, ${ IMG_BASE_URL}/img?w=1200 1200w, ${IMG_BASE_U});it('should use the long responsive srcset if sizes attribute exists and is less than 100vw',setupTestingModule({imageLoader});const template = `<img const fixture = createTestComponent(template);fixture.detectChanges();const nativeElement = fixture.nativeElement as HTMLElement;const img = nativeElement.querySelector('img')!;expect(img.getAttribute('srcset')).toBe(`${IMG_BASE_URL}/img?w=16 16w, ${IMG_BASE_URL}/img?w=32 32w, ${    IMG_BASE_URL}/img?w=48 48w, ${IMG_BASE_URL}/img?w=64 64w, ${    IMG_BASE_URL}/img?w=96 96w, ${IMG_BASE_URL}/img?w=128 128w, ${    IMG_BASE_URL}/img?w=256 256w, ${IMG_BASE_URL}/img?w=384 384w, ${    IMG_BASE_URL}/img?w=640 640w, ${IMG_BASE_URL}/img?w=750 750w, ${    IM    IMG_BASE_URL}/img?w=2048 2048w, ${IMG_BASE_URL}/img?w=3840 3840w`);it('should add a fixed srcset to the img element if sizes attribute does not exist', () => {  setupTestingModule({imageLoader});  const template = `<img ngSrc="img" width="100" height="50">    `;  const fixture = createTestComponent(template);  fixture.detectChanges();  const nativeElement = fixture.nativeElement as HTMLElement;  const img = nativeElement.querySelector('img')!;  expe});it('should not add a fixed srcset to the img element if height is too large', () => {  setupTestingModule(  fixture.detectChanges();  const nativeElement = fixture.nativeElement as HTMLElement;  const img = nativeElement.querySelector('img')!;  expect(img.getAttribut  setupTestingModule({imageLoader});  const template = `<img ngSrc="img" width="3000" height="400">`;  const fixture = createTestComponent(template);  fixture.detectChanges();  const nativeElement = fixture.nativeElement as HTMLElement;  const});it('should use a custom breakpoint set if one is provided', () => {  const imageConfig =   };  setupTestingModule({imageLoader, imageConfig});  const template = `<img ngSrc="img" width="100" height="50" sizes="2vw">    `;  fixture.detectChanges();  const nativeElement = fixture.nativeElement as HTMLElement;  const img = nativeElement.querySelector('img')!;  expec IMG_BASE_URL}/img?w=48 48w, ${IMG_BASE_URL}/img?w=64 64w, ${ IMG_BASE_URL}/img?w=9 IMG_BASE_URL}/img?w=640 640w, ${IMG_BASE_URL}/img?w=1280 1280w, ${ IMG_BASE_URL}/img?w=3840 3840w`);});it('should sort custom breakpoint set', () => {  const imageConfig = {  };  setupTestingModule({imageLoader, imageConfig});  const template = `<img ngSrc="img" width="100" height="50" sizes="2vw">    `;  fixture.detectChanges();  const nativeElement   expect(img.getAttribute('srcset')) .toBe(`${IMG_BASE_URL}/img?w=16 16w, ${IMG_BASE_URL}/img?w=48 48w, ${ IMG_BASE_URL}/img?w=640 640w, ${IMG_BASE_URL}/img?w=1280 1280w, ${ IMG_BASE_URL}/img?w=384<img ngSrc="img" width="100" height="50" sizes="50vw" disableOptimizedSrcset>    `;const fixture = createTestComponent(template);fixtureconst img = nativeElement.querySelector('img')!;expect(img.getAttribu});// Helpers// Base URL that can be used in tests to construct absolute URLs.const IMG_BASE_URL = {  // Use `toString` here to delay referencing the `window` until the tests  // execution starts, o};const ANGULAR_LOGO_BASE64 =    'da  width = 100;  height = 50;  priority = false;}function setupTestingModule(config?: {  imageConfig?: ImageConfig,  imageLoader?: ImageLoa  extraProviders?: Provider[],  component?: Type<unknown>}) {  const defaultLoader = (config: ImageLoaderConfig) => {    const isAbsolute = /^https?:\/\//.test(config.src);    return isAbsolute ? config.src : window.location.origin + '/' + config.src;  };  const loader = config?.imageLoader || defaultLoader;  const extraProviders = config?.extraProviders || [];  const providers: Provider[] = [    {pr  ];  if (config?.imageCon  }  TestBed.configureTestingModule({    declarations: [config?.component ?? TestComponent],    // Note: the `NgOptimizedImage` directive is experimental and is not a part of the    // `CommonModule` yet, so it's imported separately.    imports: [CommonModu  });}// Same as above but explicitly doesn't provide a custom loader,// so the noopImageLoader should be used.function setUpModuleNoLoader() {  TestBed.configureTestingModule({    declarations: [TestComponent],    imports: [CommonModule, NgOptimizedImage],    providers: [{provide: DOCUMENT, useValue: window.document}]  });}function createTestComponent(template: string): ComponentFixture<TestComponent> {  retur}